# 機能設計書：コンテキスト管理によるレビュー精度向上機能 (Ver. 3.0 - 最終版)

## 1. 概要

本機能は、Chrome拡張機能「Gemini Slides Reviewer」に、プレゼンテーションごとの文脈（コンテキスト）を管理・活用する仕組みを導入し、AIによるレビュー精度を飛躍的に向上させることを目的とする。

単一のスライドを静的に分析するだけでなく、「プロジェクト」という単位で、その目的、対象者、過去の議論といった動的な情報（外部コンテキスト）を考慮することで、より実践的で成果に繋がる改善提案を可能にする。

### 1.1. 主要な提供価値

-   **精度の向上**: プロジェクトの背景や目的を理解した上でレビューを行う。
-   **一貫性の担保**: 過去の定例会議での指摘などを記憶し、報告内容の一貫性を維持する。
-   **業務の効率化**: ユーザーの「コンテキスト入れ忘れ」を防ぎ、定例会議のリズムを学習して入力を補助する「秘書」機能を提供する。

## 2. ユーザーシナリオ

### シナリオ1：キックオフ資料の作成
プロジェクトマネージャー（PM）が、キックオフ資料の構成を検討する際、本機能を使って「目的」や「対象者」をAIに伝える。AIはそれを踏まえ、ストーリーラインの抜け漏れや改善点を指摘する。

### シナリオ2：週次定例報告の準備
PMが資料をコピーして週次定例の報告資料を作成する際、本機能がコピー元の資料と同一のプロジェクトであると認識。先週の会議での指摘事項をコンテキストとして引き継ぎ、AIが的確な修正案を提案する。

## 3. 機能要件

### 3.1. プロジェクト管理機能 (URL変動対応)

-   **プロジェクトID管理**: プロジェクトの識別は、URLではなく、拡張機能が内部で発行するユニークな「プロジェクトID」を正規のキーとして使用する。
-   **インテリジェントな紐付け**: ユーザーが新しいURLのスライドを開いた際、以下のロジックでプロジェクトを特定または新規作成する。
    1.  まず、URLが既存のプロジェクトIDに紐付けられているかを確認する (`urlProjectMap`)。
    2.  紐付けがない場合、スライドの「タイトル」を取得する。
    3.  取得したタイトルが、既存プロジェクトのタイトルと類似している場合、ユーザーに「既存プロジェクトの関連資料か、全く新しいプロジェクトか」を確認する。
    4.  ユーザーの選択に基づき、新しいURLを既存のプロジェクトIDに紐付けるか、新しいプロジェクトIDを発行して新規プロジェクトを作成する。
-   **データ保存**: プロジェクトに関する全データは `chrome.storage.local` に保存する。

### 3.2. コンテキスト入力機能

#### 3.2.1. プロジェクトコンテキスト（静的）
-   UI上に、以下の情報を入力できるシンプルなテキストエリアを設ける。
    -   目的
    -   対象者
    -   トーン、重要メッセージなど（自由記述欄）

#### 3.2.2. 外部コンテキスト（動的）
-   UI上に「外部コンテキストを追加」ボタンを設置する。
-   ボタンクリックで、以下の入力欄が表示される。
    -   **日付入力欄 (`<input type="date">`)**: コンテキストの発生日を入力。デフォルトは当日。
    -   **テキストエリア (`<textarea>`)**: 会議の議事録やメール文などをユーザーが手動でコピー＆ペーストする。
-   入力されたコンタキストは、日付情報と共に時系列で保存される。

### 3.3. 定例会議アシスト機能（秘書機能）

-   **リズム学習**: ユーザーが最初の外部コンテキストを入力した後、「このプロジェクトは毎週定例会議がありますか？」と確認する。
-   **日付の自動生成**: 「はい」が選択された場合、入力された日付を基準に、毎週同じ曜日の日付を持つコンテキスト入力欄のプレースホルダーを向こう3ヶ月分（約12個）自動生成する。
-   **入力催促（通知）**: 自動生成された日付当日になると、拡張機能のアイコンに通知マークを表示し、ユーザーにコンテキストの入力を促す。
-   **日付の編集・削除**: 自動生成された日付は、ユーザーが任意で編集・削除できるものとする。

### 3.4. Gemini API連携ロジック

-   **コンテキストの統合**: レビュー実行時、保存されている以下の情報を全て取得する。
    1.  プロジェクトコンテキスト（目的、対象者など）
    2.  外部コンテキスト（議事録など）
-   **優先順位付け**: 外部コンテキストは**日付の新しい順**にソートする。
-   **プロンプト生成**: ソート済みのコンテキスト情報を、レビュー対象のスライド画像と共に、構造化されたプロンプトとしてGemini APIに送信する。

## 4. データ構造（`chrome.storage.local`）

プロジェクトの実体と、URLとの紐付け情報を分離して管理する。

```json
{
  // プロジェクト本体のデータを管理 (キーはプロジェクトID)
  "projects": {
    "proj_1a2b3c": {
      "projectName": "2025年度 Q1営業報告",
      "createdAt": "2025-10-16T12:00:00Z",
      "staticContext": {
        "purpose": "新規顧客向けの製品紹介",
        "audience": "技術者ではない経営層"
      },
      "externalContexts": [
        {
          "id": "ctx_001",
          "date": "2025-10-16",
          "content": "キックオフ議事録：...",
          "status": "filled"
        },
        {
          "id": "ctx_002",
          "date": "2025-10-23",
          "content": "",
          "status": "pending"
        }
      ]
    }
  },

  // どのURLがどのプロジェクトIDに属するかを管理
  "urlProjectMap": {
    "URL_HASH_OF_ORIGINAL_SLIDE": "proj_1a2b3c",
    "URL_HASH_OF_COPIED_SLIDE": "proj_1a2b3c"
  }
}
```

## 5. UI/UX仕様

### 5.1. 基本レイアウト：タブ切り替え式サイドパネル
-   現在のサイドパネルUIを拡張し、「レビュー」と「コンテキスト」の2つのタブを設ける。これにより、普段のレビュー実行と、背景情報の管理という異なる関心事を明確に分離する。

### 5.2. プロジェクトの自動認識と表示
-   サイドパネルの最上部に、現在開いているGoogle Slidesのタイトルを「プロジェクト名」として常時表示する。
-   ユーザーがブラウザのタブで別のプレゼンテーションに切り替えた場合、パネル内の表示も即座にそのスライドに紐づくプロジェクトの内容に切り替わる。これにより、複数プロジェクト間のコンテキスト混同を防ぐ。

### 5.3. 「コンテキスト」タブの詳細レイアウト
-   タブをクリックすると、以下の要素で構成された画面が表示される。

```
+--------------------------------------------------+
| Gemini Slides Reviewer                           |
|--------------------------------------------------|
|                                                  |
|  プロジェクト:【2025年度 Q1営業報告】            |
|                                                  |
|  +-----------------+--------------------------+  |
|  |   レビュー      |   コンテキスト (🔴 1)    |  |
|  +-----------------+--------------------------+  |
|                                                  |
|  ▼ プロジェクトの基本設定                        |
|    目的: [____________________________________]  |
|    対象者: [__________________________________]  |
|                                                  |
|  ▼ 外部コンテキストの履歴                        |
|                                                  |
|    [ + 外部コンテキストを追加 ]                  |
|                                                  |
|  ┌──────────────────────────────────────────┐  |
|  | 2025-10-23 (木)  [編集] [削除]              |
|  |  部長: 根本原因が分からないと...            |
|  └──────────────────────────────────────────┘  |
|  ┌──────────────────────────────────────────┐  |
|  | 2025-10-30 (木)                            |
|  |  [ + 議事録やメモを追加する ]               |
|  └──────────────────────────────────────────┘  |
+--------------------------------------------------+
```

-   **タブの通知 (🔴)**: 「秘書機能」がユーザーに入力を促している場合、タブに通知マークを表示する。
-   **`[ + 外部コンテキストを追加 ]` ボタン**: 新しい動的コンテキスト（議事録など）を手動で追加するためのボタン。
-   **コンテキスト履歴**: 過去のコンテキストが日付の新しい順にカード形式でリスト表示される。
-   **未入力のコンテキスト**: 自動生成されたプレースホルダーは、ユーザーのアクションを促すボタンとして表示される。

## 6. MVP（Minimum Viable Product）スコープ

### 6.1. 含めるもの
-   上記3〜5の全ての機能。
-   コンテキスト入力方法は、テキストのコピー＆ペーストのみとする。

### 6.2. 見送るもの（将来の拡張）
-   PDFやWordファイルからのコンテキスト自動抽出機能。
-   Google Calendarとの連携による、会議スケジュールの自動取得。
-   プロジェクトの一覧表示や手動での紐付け編集機能。